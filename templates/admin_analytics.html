{% extends "base.html" %}

{% block title %}Analytics Dashboard - Admin{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>Analytics Dashboard</h1>
        <div>
            <select id="daysFilter" class="analytics-filter">
                <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 days</option>
                <option value="60" {% if days == 60 %}selected{% endif %}>Last 60 days</option>
                <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 days</option>
            </select>
            <a href="{{ url_for('admin_dashboard') }}" class="btn-secondary">Back to Dashboard</a>
        </div>
    </div>
    
    <div class="analytics-dashboard">
        <!-- Website Views Over Time -->
        <div class="analytics-section">
            <h2>Website Views Over Time</h2>
            <div class="chart-container">
                <canvas id="viewsChart"></canvas>
            </div>
        </div>
        
        <!-- Time on Site Stats -->
        <div class="analytics-section">
            <h2>Time on Site (Last {{ days }} days)</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ "%.1f"|format(time_stats['avg_duration'] or 0) }}</div>
                    <div class="stat-label">Average Time (seconds)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ time_stats['total_views'] or 0 }}</div>
                    <div class="stat-label">Total Page Views</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ "%.0f"|format((time_stats['total_time'] or 0) / 60) }}</div>
                    <div class="stat-label">Total Time (minutes)</div>
                </div>
            </div>
        </div>
        
        <!-- Views Per Article -->
        <div class="analytics-section">
            <h2>Views Per Article</h2>
            <div class="chart-container">
                <canvas id="articleViewsChart"></canvas>
            </div>
        </div>
        
        <!-- Article Statistics Table -->
        <div class="analytics-section">
            <h2>Article Statistics</h2>
            <div class="table-container">
                <table class="articles-table">
                    <thead>
                        <tr>
                            <th>Article</th>
                            <th>Total Views</th>
                            <th>Views (30d)</th>
                            <th>Avg Time (sec)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in article_stats %}
                        <tr>
                            <td>
                                <a href="{{ url_for('article_detail', slug=stat['slug']) }}" target="_blank">
                                    {{ stat['title'] }}
                                </a>
                            </td>
                            <td>{{ stat['total_views'] }}</td>
                            <td>{{ stat['views_30d'] }}</td>
                            <td>
                                {% for time_stat in article_time_stats %}
                                    {% if time_stat['id'] == stat['id'] %}
                                        {{ "%.1f"|format(time_stat['avg_duration'] or 0) }}
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Time on Each Article -->
        <div class="analytics-section">
            <h2>Time on Each Article</h2>
            <div class="table-container">
                <table class="articles-table">
                    <thead>
                        <tr>
                            <th>Article</th>
                            <th>Total Views</th>
                            <th>Average Time (seconds)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in article_time_stats %}
                        <tr>
                            <td>
                                <a href="{{ url_for('article_detail', slug=stat['slug']) }}" target="_blank">
                                    {{ stat['title'] }}
                                </a>
                            </td>
                            <td>{{ stat['total_views'] }}</td>
                            <td>{{ "%.1f"|format(stat['avg_duration'] or 0) }}</td>
                        </tr>
                        {% endfor %}
                        {% if not article_time_stats %}
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 2rem;">No article view data yet.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Views over time chart
    const viewsCtx = document.getElementById('viewsChart');
    if (viewsCtx) {
        new Chart(viewsCtx, {
            type: 'line',
            data: {
                labels: {{ views_chart_data.labels | tojson }},
                datasets: [{
                    label: 'Page Views',
                    data: {{ views_chart_data.data | tojson }},
                    borderColor: '#476968ff',
                    backgroundColor: 'rgba(71, 105, 104, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Article views chart
    const articleViewsCtx = document.getElementById('articleViewsChart');
    if (articleViewsCtx) {
        new Chart(articleViewsCtx, {
            type: 'bar',
            data: {
                labels: {{ article_views_data.labels | tojson }},
                datasets: [{
                    label: 'Total Views',
                    data: {{ article_views_data.data | tojson }},
                    backgroundColor: '#c97a63ff',
                    borderColor: '#c97a63ff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Days filter
    document.getElementById('daysFilter').addEventListener('change', function() {
        window.location.href = '{{ url_for("admin_analytics") }}?days=' + this.value;
    });
</script>
{% endblock %}

